
var num=0;var buttonType=0;var buttonId=[];var globalVar={x:0,y:0,spa:1,len:5,total:20,step:0,coordinateX:[],coordinateY:[]};function drawOnline(obj,e)
{if(obj.tagName.toLowerCase()=="canvas"){switch(buttonType){case 1:drawLine(obj,e);break;case 2:drawRightAgent(obj,e);break;case 3:break;case 4:break;case 0:alert("\n畫圖請點擊‘直線’和‘直角’按鈕！\n\n");buttonType=5;break;default:break;}}}
function $d(obj)
{return document.getElementById(obj);}
function setStatus(obj,type){if(buttonId.length){buttonId[buttonId.length]=obj;for(var i=0;i<buttonId.length;i++){buttonId[i].style.color="#000";}}else{buttonId[0]=obj;}
obj.style.color="red";switch(type){case 1:buttonType=1;break;case 2:buttonType=2;break;default:buttonType=3;break;}}
function drawLine(obj,e)
{var c=obj.getContext("2d");var drawNum=2;var x=e.pageX-obj.offsetLeft;var y=e.pageY-obj.offsetTop;var offX=x-(parseInt(x/20))*20;var offY=y-(parseInt(y/20))*20-20;if(offX<=5&&offX>=0){x=parseInt(x/20)*20;}else if(offX<=20&&offX>=15){x=parseInt(x/20)*20+20;}else{return;}
if(offY>=-5&&offY<=0){y=parseInt(y/20)*20+20;}else if(offY>=-20&&offY<=-15){y=parseInt(y/20)*20;}else{return;}
c.beginPath();c.arc(x,y,1,0,2*Math.PI,true);c.fillStyle="#f0f";c.fill();if(num==0){globalVar.coordinateX[num]=x;globalVar.coordinateY[num]=y;num++;}else{if(num>drawNum){if(confirm("你要重画直线吗？")){c.clearRect(0,0,920,320);clearGlobalVar(1);num=0;}}else{globalVar.coordinateX[num]=x;globalVar.coordinateY[num]=y;draw2Line(c,globalVar.coordinateX[num-1],globalVar.coordinateY[num-1],x,y,"#000");num++;}}}
function drawRightAgent(obj,e)
{var c=obj.getContext("2d");var x=e.pageX-obj.offsetLeft;var y=e.pageY-obj.offsetTop;var total=20;var len=globalVar.len;var spa=globalVar.spa;var offLen=9;var step=globalVar.step;var offX=x-(parseInt(x/20))*20;var offY=y-(parseInt(y/20))*20-20;if(offX<=offLen&&offX>=0){if(offY>=(0-offLen)&&offY<=0){step=1;}else if(offY>=-20&&offY<=(-20+offLen)){step=3;}else{return;}}else if(offX<=20&&offX>=(20-offLen)){if(offY>=(0-offLen)&&offY<=0){step=2;}else if(offY>=-20&&offY<=(-20+offLen)){step=4;}else{return;}}else{return;}
x=(parseInt(x/20))*20;y=(parseInt(y/20))*20+20;if(step==1){redraw(obj);draw2Line(c,x+len,y-spa,x+len,y-len,x+spa,y-len,"#000");}else if(step==2){redraw(obj);draw2Line(c,x+total-len,y-spa,x+total-len,y-len,x+total-spa,y-len,"#000");}else if(step==3){redraw(obj);draw2Line(c,x+len,y-total+spa,x+len,y-total+len,x+spa,y-total+len,"#000");}else if(step==4){redraw(obj);draw2Line(c,x+total-len,y-total+spa,x+total-len,y-total+len,x+total-spa,y-total+len,"#000");}else{step=0;redraw(obj);}
globalVar.x=x;globalVar.y=y;globalVar.step=step;}
function draw2Line(){var argLen=draw2Line.arguments.length;var c=draw2Line.arguments[0];if((argLen>=6)&&(argLen/2)){c.beginPath();c.moveTo(arguments[1],arguments[2]);for(var i=3;i<argLen-2;i+=2){c.lineTo(arguments[i],arguments[i+1]);}
c.strokeStyle=arguments[argLen-1];c.stroke();}else{alert("至少要取两点");}}
function redraw(obj){obj.width=obj.width;c=obj.getContext("2d");if(globalVar.coordinateX.length){for(var i=0;i<globalVar.coordinateX.length-1;i++){draw2Line(c,globalVar.coordinateX[i],globalVar.coordinateY[i],globalVar.coordinateX[i+1],globalVar.coordinateY[i+1],"#000");}}}
function resetDraw(){var canvas=$d("cvs");if(confirm("您确定要重画！")){canvas.width=canvas.width;clearGlobalVar(3);}}
function clearGlobalVar(type){if(type==3||type==1){if(globalVar.coordinateX.length){for(var i=0;i<globalVar.coordinateX.length-1;i++){globalVar.coordinateX[i]=undefined;globalVar.coordinateY[i]=undefined;}}}
if(type==3||type==2){globalVar.x=0;globalVar.y=0;globalVar.step=0;}}
function submitDraw(que_idx,ans_idx){var allAnswer="";if(globalVar.coordinateX.length<2){alert("您沒有畫直線！");return;}
if(globalVar.step==0){alert("您沒有畫直角！");return;}
for(var i=0;i<globalVar.coordinateX.length;i++){allAnswer+=globalVar.coordinateX[i]+",";allAnswer+=globalVar.coordinateY[i]+",";}
allAnswer+=globalVar.x+",";allAnswer+=globalVar.y+",";allAnswer+=globalVar.step;try{meic_set_answer(que_idx,ans_idx,allAnswer,-2,1);}catch(e){alert("提交失败："+e);return;}
if(allAnswer){alert("提交成功!");}}
function reLoadData(){try{var myObj=meic_get_answer_JSON();}catch(e){alert("加载数据出错："+e);return;}
var obj=$d("cvs");obj.width=obj.width;var c=obj.getContext("2d");var answerData;var gIndex=0;var len=globalVar.len;var spa=globalVar.spa;var total=globalVar.total;for(var j=0;j<myObj.length;j++){if((parseInt(myObj[j].que_idx)==0)&&(parseInt(myObj[j].ans_idx)==0)){answerData=myObj[j].answer.split(/[^0-9]+/);if(answerData.length){for(var i=0;i<answerData.length-3;i+=2){globalVar.coordinateX[gIndex]=parseInt(answerData[i]);globalVar.coordinateY[gIndex]=parseInt(answerData[i+1]);gIndex++;}
var x=globalVar.x=parseInt(answerData[answerData.length-3]);var y=globalVar.y=parseInt(answerData[answerData.length-2]);globalVar.step=parseInt(answerData[answerData.length-1]);for(i=0;i<gIndex;i++){draw2Line(c,globalVar.coordinateX[i],globalVar.coordinateY[i],globalVar.coordinateX[i+1],globalVar.coordinateY[i+1],"#000");}
if(globalVar.step==1){draw2Line(c,x+len,y-spa,x+len,y-len,x+spa,y-len,"#000");}else if(globalVar.step==2){draw2Line(c,x+total-len,y-spa,x+total-len,y-len,x+total-spa,y-len,"#000");}else if(globalVar.step==3){draw2Line(c,x+len,y-total+spa,x+len,y-total+len,x+spa,y-total+len,"#000");}else if(globalVar.step==4){draw2Line(c,x+total-len,y-total+spa,x+total-len,y-total+len,x+total-spa,y-total+len,"#000");}}}}}
function init()
{var canvas=$d("cvs");var c=canvas.getContext("2d");c.beginPath();}
window.onload=function()
{init();reLoadData();}